
# CVE-2023-2341 HTTP.SYS EoP

> At least 4Gb of memory is required for PoC

We can trigger an integer overflow in **UlpComputeChannelBindConfigSize** which can lead to memory corruption in **UlCopyChannelBindConfigToIrp**. Patch introduced a new check for size of *ServiceName*. That check prevents size to be greater than **0xFFFC**.

An introduced check was placed in **UlCaptureChannelBindConfig**.
![printscreen of introduced check](img/1.png)

That function can be reached by followed usermode **API** from **httpapi.dll**.

- [HttpSetServerSessionProperty](https://learn.microsoft.com/en-us/windows/win32/api/http/nf-http-httpsetserversessionproperty)
- [HttpSetUrlGroupProperty](https://learn.microsoft.com/en-us/windows/win32/api/http/nf-http-httpseturlgroupproperty)
- [HttpSendHttpResponse](https://learn.microsoft.com/en-us/windows/win32/api/http/nf-http-httpsendhttpresponse)

Memory layout of considered structures
![memorylayout](img/2.png)

**UlpComputeChannelBindConfigSize** computes the total size of memory required for whole *ChannelBindConfig* structure. We can craft a specific sequence of *ServiceName* structures which can overflow **resultSize** variable.

![printscreen of UlpComputeChannelBindConfigSize code](img/3.png)

But we should beware about few more check.

- Check in **UlpAddServiceNameToContainer** which prevent size to be greater or equal than **0xffffffe8**.
  
  ![printscreen of UlpComputeChannelBindConfigSize code](img/4.png)

- Size of ServiceName should be aligned to 8.

## Stack Trace

![printscreen of stack trace](img/5.jpg)

## Build

```shell
    cd cve-2023-23410
    cmake -S . -B build
    cmake --build build --config Release
```

## Machine systeminfo

```shell
Host Name:                 DESKTOP-19NG2CS
OS Name:                   Microsoft Windows 10 Education
OS Version:                10.0.19045 N/A Build 19045
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Standalone Workstation
OS Build Type:             Multiprocessor Free
Registered Owner:          Windows User
Registered Organization:
Product ID:                00328-00000-00000-AA110
Original Install Date:     27/03/2023, 14:36:49
System Boot Time:          10/05/2023, 19:57:35
System Manufacturer:       VMware, Inc.
System Model:              VMware7,1
System Type:               x64-based PC
Processor(s):              1 Processor(s) Installed.
                           [01]: Intel64 Family 6 Model 165 Stepping 5 GenuineIntel ~3792 Mhz
BIOS Version:              VMware, Inc. VMW71.00V.16722896.B64.2008100651, 10/08/2020
Windows Directory:         C:\Windows
System Directory:          C:\Windows\system32
Boot Device:               \Device\HarddiskVolume1
System Locale:             en-gb;English (United Kingdom)
Input Locale:              en-gb;English (United Kingdom)
Time Zone:                 (UTC+03:00) Kuwait, Riyadh
Total Physical Memory:     4,095 MB
Available Physical Memory: 1,666 MB
Virtual Memory: Max Size:  8,191 MB
Virtual Memory: Available: 6,180 MB
Virtual Memory: In Use:    2,011 MB
Page File Location(s):     C:\pagefile.sys
Domain:                    WORKGROUP
Logon Server:              \\DESKTOP-19NG2CS
Hotfix(s):                 6 Hotfix(s) Installed.
                           [01]: KB5017022
                           [02]: KB5015684
                           [03]: KB5022834
                           [04]: KB5014032
                           [05]: KB5016705
                           [06]: KB5020372
Network Card(s):           1 NIC(s) Installed.
                           [01]: Bluetooth Device (Personal Area Network)
                                 Connection Name: Bluetooth Network Connection
                                 Status:          Media disconnected
Hyper-V Requirements:      A hypervisor has been detected. Features required for Hyper-V will not be displayed.
```
